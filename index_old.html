<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>抖音-老六说电脑-定制浏览器主页</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'haze-blue': '#E0E9FF',
                        'mint-green': '#E6FFFA',
                        'cherry-pink': '#FFF0F5',
                        'avocado-green': '#E8F5E9',
                        'carbon-gray': '#1E293B',
                        'morandi-grayblue': '#94A3B8',
                        'milk-coffee': '#F5EFE7',
                        'haze-purple': '#DCD6F7',
                        'ice-fog-white': '#F8FAFC',
                        'milk-cream-yellow': '#FFFBEB',
                        'taro-purple': '#DED7F6',
                        'haze-gray': '#F1F5F9',
                        'mango-orange': '#FFF3E0',
                        'blueberry-jam': '#E3F2FD',
                        'grapefruit-red': '#FFE0E6'
                    },
                    animation: {
                        'ripple': 'ripple 0.6s ease-out',
                        'radio-pulse': 'radio-pulse 0.3s ease-out'
                    },
                    keyframes: {
                        ripple: {
                            '0%': { transform: 'scale(0.8)', opacity: 1 },
                            '100%': { transform: 'scale(1.2)', opacity: 0 }
                        },
                        'radio-pulse': {
                            '0%': { box-shadow: '0 0 0 0 #AA6666' },
                            '70%': { box-shadow: '0 0 0 8px transparent' },
                            '100%': { box-shadow: '0 0 0 0 transparent' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto', sans-serif;
        }
        body {
            min-height: 100vh;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            transition: background-color 0.3s ease, background-image 0.3s ease;
        }
        /* 胶囊按钮样式 */
        .capsule-btn {
            border-radius: 9999px;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border: 1px solid #000000;
            cursor: pointer;
            background: white/90;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .capsule-btn:active {
            transform: scale(0.98);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        /* 波纹动效容器 */
        .ripple-container {
            position: relative;
            overflow: hidden;
        }
        .ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(255,255,255,0.6);
            transform: scale(0);
            animation: ripple 0.6s ease-out;
            pointer-events: none;
        }
        /* 搜索区域样式 */
        .search-input {
            border-radius: 9999px 0 0 9999px;
            border: 1px solid #000000;
            border-right: none;
            padding: 12px 20px;
            outline: none;
            font-size: 16px;
            width: 100%;
            max-width: 600px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .search-btn {
            border-radius: 0 9999px 9999px 0;
            border: 1px solid #000000;
            padding: 12px 24px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }
        .search-btn:active {
            transform: scale(0.98);
        }
        /* 延迟显示样式 */
        .delay-text {
            font-size: 12px;
            margin-left: 8px;
        }
        .delay-green {
            color: #2ecc71;
        }
        .delay-yellow {
            color: #f39c12;
        }
        .delay-red {
            color: #e74c3c;
        }
        /* 最快引擎提示样式 */
        .fastest-engine {
            font-size: 14px;
            margin-top: 8px;
            color: #333;
        }
        /* 模态框样式 - 核心修改：背景色跟随主题 */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            border-radius: 16px;
            padding: 24px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            text-align: center;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s ease;
        }
        .modal-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 24px;
            transition: color 0.3s ease;
        }
        .radio-group {
            margin-bottom: 24px;
            text-align: left;
            flex: 1;
            overflow-y: auto;
            padding-right: 8px;
        }
        .radio-option {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border-radius: 12px;
            margin: 8px 0;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .radio-option:hover {
            background-color: rgba(0,0,0,0.05);
        }
        .radio-option.selected {
            background-color: rgba(0,0,0,0.1);
        }
        /* 刷新按钮样式 */
        .refresh-btn {
            margin-right: 8px;
            padding: 4px;
            border-radius: 50%;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease;
        }
        .refresh-btn:hover {
            background-color: rgba(0,0,0,0.1);
        }
        .refresh-btn.show {
            display: flex;
        }
        /* 文件名显示样式 */
        .filename-label {
            font-size: 12px;
            color: #666;
            margin-left: 8px;
            max-width: 150px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        /* 单选按钮样式 - 颜色跟随深对比色 */
        .radio-option input[type="radio"] {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            outline: none;
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
        }
        .radio-option input[type="radio"]:checked {
            animation: radio-pulse 0.3s ease-out;
        }
        .radio-option input[type="radio"]:checked::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 8px;
            height: 8px;
            background-color: white;
            border-radius: 50%;
        }
        /* 模态框底部按钮 - 颜色跟随深对比色 */
        .modal-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: auto;
        }
        .modal-footer button {
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .modal-footer .cancel-btn {
            border: 1px solid;
            background: transparent;
        }
        .modal-footer .confirm-btn {
            border: 1px solid;
            background: transparent;
            font-weight: 500;
        }
        .modal-footer .cancel-btn:hover,
        .modal-footer .confirm-btn:hover {
            background-color: rgba(0,0,0,0.05);
        }
        /* 响应式适配 */
        @media (max-width: 768px) {
            .time-display {
                font-size: 4rem !important;
            }
            .search-input {
                max-width: 400px;
            }
        }
    </style>
    <link rel="icon" href="icon.ico" type="image/x-icon">
</head>
<body class="cherry-pink/30">
    <!-- 左上角功能按钮 -->
    <div class="absolute top-4 left-4 flex flex-col gap-4 z-10">
        <button class="capsule-btn ripple-container" id="wallpaperBtn" style="background-color: #FFF0F5;">
            <span class="material-icons">wallpaper</span>
            <span>壁纸</span>
        </button>
        <button class="capsule-btn ripple-container" id="themeBtn" style="background-color: #FFF0F5;">
            <span class="material-icons">palette</span>
            <span>主题颜色</span>
        </button>
    </div>

    <!-- 右下角恢复默认按钮 -->
    <button class="capsule-btn ripple-container absolute bottom-4 right-4 z-10" id="resetBtn" style="background-color: #FFF0F5;">
        <span class="material-icons">restore</span>
        <span>恢复默认</span>
    </button>

    <!-- 核心内容区 -->
    <div class="flex flex-col items-center justify-center min-h-screen px-4">
        <div class="time-display text-7xl font-bold text-gray-800 mb-2" id="time">00:00:00</div>
        <div class="text-lg text-gray-700 mb-8 text-center" id="date">2026/01/26        星期一</div>
        
        <div class="w-full max-w-2xl mb-4">
            <div class="flex items-center justify-center">
                <input type="text" class="search-input" id="searchInput" placeholder="请输入搜索内容...">
                <button class="search-btn" id="searchBtn" style="background-color: #FFF0F5;">
                    <span class="material-icons">search</span>
                </button>
            </div>
            <div class="mt-4 flex justify-center">
                <button class="capsule-btn ripple-container" id="engineBtn" style="background-color: #FFF0F5;">
                    <span class="material-icons">search</span>
                    <span id="currentEngineText">当前搜索引擎：必应</span>
                </button>
            </div>
            <!-- 新增：当前最快引擎显示 -->
            <div class="flex justify-center fastest-engine" id="fastestEngineText">
                当前访问最快：检测中...
            </div>
        </div>
    </div>

    <!-- 搜索引擎选择弹窗 -->
    <div class="modal" id="engineModal">
        <div class="modal-content" style="background-color: #FFF0F5;">
            <div class="modal-title" style="color: #AA6666;">选择搜索引擎</div>
            <div class="radio-group">
                <label class="radio-option ripple-container selected" id="bingOption">
                    <span>必应<span class="delay-text" id="bingDelay">--ms</span></span>
                    <input type="radio" name="engine" value="bing" checked style="border: 2px solid #AA6666; background-color: #AA6666;">
                </label>
                <label class="radio-option ripple-container" id="googleOption">
                    <span>Google<span class="delay-text" id="googleDelay">不可访问</span></span>
                    <input type="radio" name="engine" value="google" style="border: 2px solid #AA6666; background-color: transparent;">
                </label>
                <label class="radio-option ripple-container" id="baiduOption">
                    <span>百度<span class="delay-text" id="baiduDelay">--ms</span></span>
                    <input type="radio" name="engine" value="baidu" style="border: 2px solid #AA6666; background-color: transparent;">
                </label>
                <label class="radio-option ripple-container" id="360Option">
                    <span>360<span class="delay-text" id="360Delay">--ms</span></span>
                    <input type="radio" name="engine" value="360" style="border: 2px solid #AA6666; background-color: transparent;">
                </label>
                <label class="radio-option ripple-container" id="sogouOption">
                    <span>搜狗<span class="delay-text" id="sogouDelay">--ms</span></span>
                    <input type="radio" name="engine" value="sogou" style="border: 2px solid #AA6666; background-color: transparent;">
                </label>
            </div>
            <div class="modal-footer">
                <button class="cancel-btn" style="border-color: #AA6666; color: #AA6666;" id="closeEngineModal">取消</button>
                <button class="confirm-btn" style="border-color: #AA6666; color: #AA6666;" id="confirmEngine">确认</button>
            </div>
        </div>
    </div>

    <!-- 壁纸设置弹窗 -->
    <div class="modal" id="wallpaperModal">
        <div class="modal-content" style="background-color: #FFF0F5;">
            <div class="modal-title" style="color: #AA6666;">壁纸设置</div>
            <div class="radio-group">
                <label class="radio-option ripple-container" id="noneWallpaperOption">
                    <span>无壁纸（使用主题色）</span>
                    <input type="radio" name="wallpaperType" value="none" style="border: 2px solid #AA6666; background-color: transparent;">
                </label>
                <label class="radio-option ripple-container selected" id="networkWallpaperOption">
                    <span class="refresh-btn" id="refreshWallpaperBtn">
                        <span class="material-icons" style="font-size: 16px; color: #AA6666;">refresh</span>
                    </span>
                    <span>网络壁纸（随机）</span>
                    <input type="radio" name="wallpaperType" value="network" checked style="border: 2px solid #AA6666; background-color: #AA6666;">
                </label>
                <label class="radio-option ripple-container" id="localWallpaperOption">
                    <span>本地图片</span>
                    <span class="filename-label" id="localFilename"></span>
                    <input type="radio" name="wallpaperType" value="local" style="border: 2px solid #AA6666; background-color: transparent;">
                </label>
            </div>
            <input type="file" id="localWallpaper" accept="image/*" class="hidden mt-2">
            <div class="modal-footer">
                <button class="cancel-btn" style="border-color: #AA6666; color: #AA6666;" id="closeWallpaperModal">取消</button>
                <button class="confirm-btn" style="border-color: #AA6666; color: #AA6666;" id="confirmWallpaper">确认</button>
            </div>
        </div>
    </div>

    <!-- 主题色设置弹窗 -->
    <div class="modal" id="themeModal">
        <div class="modal-content" style="background-color: #FFF0F5;">
            <div class="modal-title" style="color: #AA6666;">Google原生Android主题色</div>
            <div class="radio-group" id="colorOptions">
                <!-- 颜色选项由JS动态生成 -->
            </div>
            <div class="modal-footer">
                <button class="cancel-btn" style="border-color: #AA6666; color: #AA6666;" id="closeThemeModal">取消</button>
                <button class="confirm-btn" style="border-color: #AA6666; color: #AA6666;" id="confirmTheme">确认</button>
            </div>
        </div>
    </div>

    <!-- 恢复默认确认弹窗 -->
    <div class="modal" id="resetModal">
        <div class="modal-content" style="background-color: #FFF0F5;">
            <div class="modal-title" style="color: #AA6666;">确认恢复默认设置？</div>
            <div class="modal-footer">
                <button class="cancel-btn" style="border-color: #AA6666; color: #AA6666;" id="cancelReset">否</button>
                <button class="confirm-btn" style="border-color: #AA6666; color: #AA6666;" id="confirmReset">是</button>
            </div>
        </div>
    </div>

    <script>
        let currentEngine = 'bing'; // 默认改为必应
        let currentTheme = 'cherry-pink';
        let currentThemeColor = '#FFF0F5';
        let currentDarkColor = '#AA6666'; // 比主题色深50%
        let wallpaperType = 'network';
        let wallpaperUrl = '';
        let localFileName = '';
        // 搜索引擎配置 - 改用无跨域的图片URL检测
        const engineConfig = {
            'bing': { 
                name: '必应', 
                searchUrl: 'https://www.bing.com/search?q=',
                testUrl: 'https://www.bing.com/favicon.ico', // 无跨域小图标
                delay: -1 
            },
            'google': { 
                name: 'Google', 
                searchUrl: 'https://www.google.com/search?q=',
                testUrl: 'https://www.google.com/favicon.ico',
                delay: -3, // 标记为不可访问
                isUnreachable: true 
            },
            'baidu': { 
                name: '百度', 
                searchUrl: 'https://www.baidu.com/s?wd=',
                testUrl: 'https://www.baidu.com/favicon.ico',
                delay: -1 
            },
            '360': { 
                name: '360', 
                searchUrl: 'https://www.so.com/s?q=',
                testUrl: 'https://www.so.com/favicon.ico',
                delay: -1 
            },
            'sogou': { 
                name: '搜狗', 
                searchUrl: 'https://www.sogou.com/web?query=',
                testUrl: 'https://www.sogou.com/favicon.ico',
                delay: -1 
            }
        };
        // 颜色映射表：名称 -> (类名, 主题色, 深50%对比色)
        const colorMap = {
            '雾霾蓝': ['haze-blue', '#E0E9FF', '#8099CC'],
            '薄荷绿': ['mint-green', '#E6FFFA', '#86CCCC'],
            '樱花粉': ['cherry-pink', '#FFF0F5', '#AA6666'],
            '牛油果绿': ['avocado-green', '#E8F5E9', '#88B599'],
            '碳灰色': ['carbon-gray', '#1E293B', '#0E192B'],
            '莫兰迪灰蓝': ['morandi-grayblue', '#94A3B8', '#546378'],
            '奶咖色': ['milk-coffee', '#F5EFE7', '#A58E77'],
            '雾霾紫': ['haze-purple', '#DCD6F7', '#8C86B7'],
            '冰雾白': ['ice-fog-white', '#F8FAFC', '#A8B0B4'],
            '奶霜黄': ['milk-cream-yellow', '#FFFBEB', '#BB996B'],
            '芋泥紫': ['taro-purple', '#DED7F6', '#8E87B6'],
            '雾霾灰': ['haze-gray', '#F1F5F9', '#A1A5B9'],
            '芒果橙': ['mango-orange', '#FFF3E0', '#BB9380'],
            '蓝莓酱': ['blueberry-jam', '#E3F2FD', '#83A2CD'],
            '西柚红': ['grapefruit-red', '#FFE0E6', '#BB7076']
        };

        // 等待DOM完全加载后再执行初始化
        document.addEventListener('DOMContentLoaded', function() {
            init();
            // 初始化延迟检测，之后每隔8秒刷新一次（降低频率，避免频繁请求）
            checkAllEngineDelay();
            setInterval(checkAllEngineDelay, 8000);
        });

        function init() {
            // 1. 加载本地存储的设置（优先级最高）
            loadSettings();
            // 2. 初始化颜色选项（根据当前主题生成）
            initColorOptions();
            // 3. 强制同步所有元素的主题色（关键步骤）
            syncAllElementsTheme();
            // 4. 更新时间日期
            updateTimeDate();
            setInterval(updateTimeDate, 1000);
            // 5. 初始化壁纸
            if (wallpaperType === 'network') {
                setRandomWallpaper(false);
                showRefreshBtn(true);
            } else if (wallpaperType === 'local' && localFileName) {
                document.getElementById('localFilename').textContent = localFileName;
            }
            // 6. 更新当前引擎显示文字
            updateCurrentEngineText();
            // 7. 初始化不可访问引擎的显示
            updateUnreachableEngineDisplay();
            // 8. 绑定所有事件
            bindEvents();
        }

        // 核心函数：强制同步所有元素的主题色和深对比色
        function syncAllElementsTheme() {
            // 1. 更新body类名和背景色（无壁纸时）
            document.body.className = `${currentTheme}/30`;
            if (wallpaperType === 'none') {
                document.body.style.backgroundColor = currentThemeColor;
            } else {
                document.body.style.backgroundColor = '';
            }

            // 2. 更新所有功能按钮背景色
            const functionBtns = [
                document.getElementById('wallpaperBtn'),
                document.getElementById('themeBtn'),
                document.getElementById('resetBtn'),
                document.getElementById('engineBtn'),
                document.getElementById('searchBtn')
            ];
            functionBtns.forEach(btn => {
                if (btn) btn.style.backgroundColor = currentThemeColor;
            });

            // 3. 更新所有弹窗的样式
            const modals = document.querySelectorAll('.modal-content');
            const modalTitles = document.querySelectorAll('.modal-title');
            const modalTexts = document.querySelectorAll('.radio-option span:not(.filename-label):not(.material-icons):not(.delay-text)');
            const modalBtns = document.querySelectorAll('.modal-footer button');
            const allRadios = document.querySelectorAll('.radio-option input[type="radio"]');

            modals.forEach(modal => {
                modal.style.backgroundColor = currentThemeColor;
            });
            modalTitles.forEach(title => {
                title.style.color = currentDarkColor;
            });
            modalTexts.forEach(text => {
                text.style.color = currentDarkColor;
            });
            modalBtns.forEach(btn => {
                btn.style.borderColor = currentDarkColor;
                btn.style.color = currentDarkColor;
            });

            // 4. 更新所有单选框样式
            allRadios.forEach(radio => {
                radio.style.border = `2px solid ${currentDarkColor}`;
                if (radio.checked) {
                    radio.style.backgroundColor = currentDarkColor;
                } else {
                    radio.style.backgroundColor = 'transparent';
                }
            });

            // 5. 更新脉冲动画颜色
            document.styleSheets[1].cssRules[1].style.boxShadow = `0 0 0 0 ${currentDarkColor}`;

            // 6. 更新选中高亮
            updateSelectedHighlight();
        }

        // 显示/隐藏刷新按钮
        function showRefreshBtn(show) {
            const refreshBtn = document.getElementById('refreshWallpaperBtn');
            if (show) {
                refreshBtn.classList.add('show');
            } else {
                refreshBtn.classList.remove('show');
            }
        }

        // 颜色加深工具函数：hex转rgb再加深50%
        function darkenColor(hex, percent = 50) {
            // 去除#号
            hex = hex.replace(/^#/, '');
            // 转成rgb
            let r = parseInt(hex.substring(0, 2), 16);
            let g = parseInt(hex.substring(2, 4), 16);
            let b = parseInt(hex.substring(4, 6), 16);
            // 加深颜色
            r = Math.floor(r * (1 - percent / 100));
            g = Math.floor(g * (1 - percent / 100));
            b = Math.floor(b * (1 - percent / 100));
            // 转回hex
            r = r.toString(16).padStart(2, '0');
            g = g.toString(16).padStart(2, '0');
            b = b.toString(16).padStart(2, '0');
            return `#${r}${g}${b}`;
        }

        function updateTimeDate() {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            document.getElementById('time').textContent = `${hours}:${minutes}:${seconds}`;
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            const weekDays = ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'];
            const weekDay = weekDays[now.getDay()];
            document.getElementById('date').textContent = `${year}/${month}/${day}        ${weekDay}`;
        }

        // 终极方案：图片加载检测延迟（避开跨域）
        function checkEngineDelay(engineKey, retryCount = 0) {
            const engine = engineConfig[engineKey];
            // 不可访问的引擎直接跳过
            if (engine.isUnreachable) return;

            const img = new Image();
            const startTime = performance.now();
            img.src = `${engine.testUrl}?t=${Date.now()}`; // 加时间戳防缓存
            img.crossOrigin = 'Anonymous';

            // 加载成功
            img.onload = function() {
                const endTime = performance.now();
                engine.delay = Math.floor(endTime - startTime);
                updateEngineDelayDisplay(engineKey);
            };

            // 加载失败（跨域或网络问题）
            img.onerror = function() {
                if (retryCount < 2) { // 最多重试2次
                    setTimeout(() => checkEngineDelay(engineKey, retryCount + 1), 800);
                } else {
                    engine.delay = -1; // 标记为失败
                    updateEngineDelayDisplay(engineKey);
                }
            };

            // 超时
            img.ontimeout = function() {
                if (retryCount < 2) {
                    setTimeout(() => checkEngineDelay(engineKey, retryCount + 1), 800);
                } else {
                    engine.delay = -2; // 标记为超时
                    updateEngineDelayDisplay(engineKey);
                }
            };

            // 设置超时时间
            img.timeout = 5000;
        }

        // 检测所有引擎延迟
        function checkAllEngineDelay() {
            Object.keys(engineConfig).forEach(key => {
                checkEngineDelay(key);
            });
            // 延迟更新最快引擎（等所有检测+重试完成）
            setTimeout(updateFastestEngine, 7000);
        }

        // 更新引擎延迟显示
        function updateEngineDelayDisplay(engineKey) {
            const engine = engineConfig[engineKey];
            const delayElement = document.getElementById(`${engineKey}Delay`);
            if (!delayElement) return;

            let delayText = '';
            let delayClass = '';

            if (engine.isUnreachable) {
                delayText = '不可访问';
                delayClass = 'delay-red';
            } else if (engine.delay === -1) {
                delayText = '连接失败';
                delayClass = 'delay-red';
            } else if (engine.delay === -2) {
                delayText = '超时';
                delayClass = 'delay-red';
            } else {
                delayText = `${engine.delay}ms`;
                if (engine.delay <= 100) {
                    delayClass = 'delay-green';
                } else if (engine.delay <= 300) {
                    delayClass = 'delay-yellow';
                } else {
                    delayClass = 'delay-red';
                }
            }

            // 应用样式
            delayElement.className = 'delay-text';
            delayElement.classList.add(delayClass);
            delayElement.textContent = delayText;
        }

        // 更新不可访问引擎的初始显示
        function updateUnreachableEngineDisplay() {
            Object.keys(engineConfig).forEach(key => {
                if (engineConfig[key].isUnreachable) {
                    const delayElement = document.getElementById(`${key}Delay`);
                    if (delayElement) {
                        delayElement.className = 'delay-text delay-red';
                        delayElement.textContent = '不可访问';
                    }
                }
            });
        }

        // 更新最快引擎显示
        function updateFastestEngine() {
            let fastestKey = currentEngine;
            let fastestDelay = Infinity;

            Object.keys(engineConfig).forEach(key => {
                const engine = engineConfig[key];
                if (!engine.isUnreachable && engine.delay > 0 && engine.delay < fastestDelay) {
                    fastestDelay = engine.delay;
                    fastestKey = key;
                }
            });

            const fastestEngine = engineConfig[fastestKey];
            let displayText = '';
            if (fastestDelay === Infinity) {
                displayText = '当前访问最快：无可用引擎';
            } else {
                let delayClass = 'delay-green';
                if (fastestDelay > 100 && fastestDelay <= 300) {
                    delayClass = 'delay-yellow';
                } else if (fastestDelay > 300) {
                    delayClass = 'delay-red';
                }
                displayText = `当前访问最快：<span>${fastestEngine.name}</span> (<span class="${delayClass}">${fastestDelay}ms</span>)`;
            }

            document.getElementById('fastestEngineText').innerHTML = displayText;
        }

        // 更新当前引擎显示文字
        function updateCurrentEngineText() {
            const engineName = engineConfig[currentEngine].name;
            document.getElementById('currentEngineText').textContent = `当前搜索引擎：${engineName}`;
        }

        // 新增：isSave参数控制是否保存设置，刷新时不保存
        function setRandomWallpaper(isSave = true) {
            const width = screen.width;
            const height = screen.height;
            wallpaperUrl = `https://picsum.photos/${width}/${height}?random=${Date.now()}`;
            document.body.style.backgroundImage = `url(${wallpaperUrl})`;
            document.body.style.backgroundColor = '';
            if (isSave) {
                wallpaperType = 'network';
                saveSettings();
            }
            adjustTextColorForBackground();
        }

        function setNoWallpaper() {
            document.body.style.backgroundImage = 'none';
            document.body.style.backgroundColor = currentThemeColor;
            wallpaperType = 'none';
            saveSettings();
            adjustTextColorForBackground();
        }

        // 初始化颜色选项 - 强制选中当前主题
        function initColorOptions() {
            const colorContainer = document.getElementById('colorOptions');
            colorContainer.innerHTML = '';

            for (const [colorName, [colorClass, colorCode, darkCode]] of Object.entries(colorMap)) {
                const isSelected = colorClass === currentTheme;
                
                const radioOption = document.createElement('label');
                radioOption.className = `radio-option ripple-container ${isSelected ? 'selected' : ''}`;
                
                const span = document.createElement('span');
                span.textContent = `${colorName}（${colorCode}）`;
                span.style.color = currentDarkColor;
                
                const radio = document.createElement('input');
                radio.type = 'radio';
                radio.name = 'themeColor';
                radio.value = colorClass;
                radio.checked = isSelected;
                // 直接设置单选框样式
                radio.style.border = `2px solid ${currentDarkColor}`;
                radio.style.backgroundColor = isSelected ? currentDarkColor : 'transparent';
                
                radioOption.appendChild(span);
                radioOption.appendChild(radio);
                colorContainer.appendChild(radioOption);
            }
        }

        // 应用主题色 - 直接修改变量+强制同步
        function applyTheme() {
            const selectedRadio = document.querySelector('input[name="themeColor"]:checked');
            if (!selectedRadio) return;

            // 获取选中的主题信息
            const selectedClass = selectedRadio.value;
            for (const [name, [cls, code, darkCode]] of Object.entries(colorMap)) {
                if (cls === selectedClass) {
                    currentTheme = cls;
                    currentThemeColor = code;
                    currentDarkColor = darkCode;
                    break;
                }
            }

            // 强制同步所有元素
            syncAllElementsTheme();
            // 保存设置
            saveSettings();
            // 调整文字颜色
            adjustTextColorForBackground();
        }

        function adjustTextColorForBackground() {
            const timeElement = document.getElementById('time');
            const dateElement = document.getElementById('date');
            const computedStyle = window.getComputedStyle(document.body);
            const bgImage = computedStyle.backgroundImage;
            
            if (bgImage !== 'none') {
                const img = new Image();
                img.crossOrigin = 'Anonymous';
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = 1;
                    canvas.height = 1;
                    ctx.drawImage(img, 0, 0, 1, 1);
                    const pixel = ctx.getImageData(0, 0, 1, 1).data;
                    const brightness = (0.299 * pixel[0] + 0.587 * pixel[1] + 0.114 * pixel[2]) / 255;
                    timeElement.style.color = brightness < 0.5 ? 'white' : 'black';
                    dateElement.style.color = brightness < 0.5 ? 'white' : 'black';
                };
                img.src = bgImage.replace(/^url\(["']?/, '').replace(/["']?\)$/, '');
            } else {
                // 无壁纸时根据主题色亮度判断
                const rgb = currentThemeColor.match(/\d+/g) || [255,255,255];
                const brightness = (0.299 * rgb[0] + 0.587 * rgb[1] + 0.114 * rgb[2]) / 255;
                timeElement.style.color = brightness < 0.5 ? 'white' : 'black';
                dateElement.style.color = brightness < 0.5 ? 'white' : 'black';
            }
        }

        function search() {
            const keyword = document.getElementById('searchInput').value.trim();
            if (!keyword) {
                alert('请输入搜索内容！');
                return;
            }
            const engine = engineConfig[currentEngine];
            if (engine.isUnreachable) {
                alert(`${engine.name}在当前网络环境下无法访问，请选择其他搜索引擎！`);
                return;
            }
            const searchUrl = `${engine.searchUrl}${encodeURIComponent(keyword)}`;
            window.open(searchUrl, '_self');
        }

        // 保存设置新增localFileName
        function saveSettings() {
            const settings = {
                currentEngine,
                currentTheme,
                currentThemeColor,
                currentDarkColor,
                wallpaperType,
                wallpaperUrl,
                localFileName
            };
            localStorage.setItem('browserHomeSettings', JSON.stringify(settings));
        }

        // 加载设置新增localFileName
        function loadSettings() {
            const saved = localStorage.getItem('browserHomeSettings');
            if (saved) {
                const settings = JSON.parse(saved);
                currentEngine = settings.currentEngine || 'bing';
                currentTheme = settings.currentTheme || 'cherry-pink';
                currentThemeColor = settings.currentThemeColor || '#FFF0F5';
                currentDarkColor = settings.currentDarkColor || '#AA6666';
                wallpaperType = settings.wallpaperType || 'network';
                wallpaperUrl = settings.wallpaperUrl || '';
                localFileName = settings.localFileName || '';
                
                // 设置搜索引擎选中状态
                const engineRadio = document.querySelector(`input[name="engine"][value="${currentEngine}"]`);
                if (engineRadio) engineRadio.checked = true;
                
                // 设置壁纸类型选中状态
                const wallpaperRadio = document.querySelector(`input[name="wallpaperType"][value="${wallpaperType}"]`);
                if (wallpaperRadio) wallpaperRadio.checked = true;

                // 更新搜索引擎显示文本
                updateCurrentEngineText();
                
                // 恢复壁纸
                if (wallpaperType === 'network' && wallpaperUrl) {
                    document.body.style.backgroundImage = `url(${wallpaperUrl})`;
                } else if (wallpaperType === 'none') {
                    document.body.style.backgroundImage = 'none';
                    document.body.style.backgroundColor = currentThemeColor;
                } else if (wallpaperType === 'local' && wallpaperUrl) {
                    document.body.style.backgroundImage = `url(${wallpaperUrl})`;
                    document.getElementById('localFilename').textContent = localFileName;
                }
            }
        }

        function updateSelectedHighlight() {
            document.querySelectorAll('.radio-option').forEach(option => {
                option.classList.remove('selected');
                if (option.querySelector('input:checked')) {
                    option.classList.add('selected');
                }
            });
        }

        function bindEvents() {
            // 波纹动效
            document.querySelectorAll('.ripple-container').forEach(container => {
                container.addEventListener('click', function(e) {
                    const ripple = document.createElement('span');
                    const rect = this.getBoundingClientRect();
                    const size = Math.max(rect.width, rect.height);
                    ripple.className = 'ripple';
                    ripple.style.width = ripple.style.height = `${size}px`;
                    ripple.style.left = `${e.clientX - rect.left - size/2}px`;
                    ripple.style.top = `${e.clientY - rect.top - size/2}px`;
                    this.appendChild(ripple);
                    setTimeout(() => ripple.remove(), 600);
                });
            });

            // 搜索引擎弹窗
            document.getElementById('engineBtn').addEventListener('click', () => {
                document.getElementById('engineModal').style.display = 'flex';
                // 打开弹窗时刷新一次延迟
                checkAllEngineDelay();
            });
            document.getElementById('closeEngineModal').addEventListener('click', () => {
                document.getElementById('engineModal').style.display = 'none';
            });
            document.getElementById('confirmEngine').addEventListener('click', () => {
                const selected = document.querySelector('input[name="engine"]:checked');
                if (selected) {
                    currentEngine = selected.value;
                    updateCurrentEngineText();
                    saveSettings();
                }
                document.getElementById('engineModal').style.display = 'none';
            });

            // 壁纸弹窗 - 核心优化事件绑定
            document.getElementById('wallpaperBtn').addEventListener('click', () => {
                document.getElementById('wallpaperModal').style.display = 'flex';
                // 打开弹窗时根据选中状态显示/隐藏刷新按钮
                const isNetworkSelected = document.querySelector('input[name="wallpaperType"][value="network"]').checked;
                showRefreshBtn(isNetworkSelected);
            });
            document.getElementById('closeWallpaperModal').addEventListener('click', () => {
                document.getElementById('wallpaperModal').style.display = 'none';
            });
            document.getElementById('confirmWallpaper').addEventListener('click', () => {
                const selected = document.querySelector('input[name="wallpaperType"]:checked');
                if (selected) {
                    const selectedType = selected.value;
                    if (selectedType === 'network') {
                        setRandomWallpaper();
                    } else if (selectedType === 'none') {
                        setNoWallpaper();
                    }
                    // 本地图片已在选择时处理
                }
                document.getElementById('wallpaperModal').style.display = 'none';
            });

            // 刷新按钮点击事件
            document.getElementById('refreshWallpaperBtn').addEventListener('click', function(e) {
                e.stopPropagation(); // 阻止触发radio的change事件
                setRandomWallpaper(false); // 刷新不保存设置
            });

            // 壁纸类型切换事件 - 控制刷新按钮显示/隐藏
            document.querySelectorAll('input[name="wallpaperType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const isNetwork = this.value === 'network';
                    showRefreshBtn(isNetwork);
                    
                    // 点击本地图片时直接触发文件选择
                    if (this.value === 'local') {
                        document.getElementById('localWallpaper').click();
                    }
                });
            });

            // 本地壁纸选择优化 - 选完自动应用并显示文件名
            document.getElementById('localWallpaper').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    localFileName = file.name;
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        wallpaperUrl = event.target.result;
                        document.body.style.backgroundImage = `url(${wallpaperUrl})`;
                        document.body.style.backgroundColor = '';
                        wallpaperType = 'local';
                        // 显示文件名
                        document.getElementById('localFilename').textContent = localFileName;
                        // 自动选中本地图片选项
                        document.querySelector('input[name="wallpaperType"][value="local"]').checked = true;
                        updateSelectedHighlight();
                        saveSettings();
                        adjustTextColorForBackground();
                    };
                    reader.readAsDataURL(file);
                }
            });

            // 主题色弹窗 - 打开时强制同步选中状态
            document.getElementById('themeBtn').addEventListener('click', () => {
                // 重新初始化颜色选项，确保选中当前主题
                initColorOptions();
                document.getElementById('themeModal').style.display = 'flex';
            });
            document.getElementById('closeThemeModal').addEventListener('click', () => {
                document.getElementById('themeModal').style.display = 'none';
            });
            document.getElementById('confirmTheme').addEventListener('click', () => {
                applyTheme();
                document.getElementById('themeModal').style.display = 'none';
            });

            // 搜索功能
            document.getElementById('searchBtn').addEventListener('click', search);
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') search();
            });

            // 恢复默认
            document.getElementById('resetBtn').addEventListener('click', () => {
                document.getElementById('resetModal').style.display = 'flex';
            });
            document.getElementById('confirmReset').addEventListener('click', () => {
                localStorage.removeItem('browserHomeSettings');
                currentEngine = 'bing'; // 恢复默认必应
                currentTheme = 'cherry-pink';
                currentThemeColor = '#FFF0F5';
                currentDarkColor = '#AA6666';
                wallpaperType = 'network';
                localFileName = '';
                
                // 重置单选按钮状态
                document.querySelector('input[name="engine"][value="bing"]').checked = true;
                document.querySelector('input[name="wallpaperType"][value="network"]').checked = true;
                document.getElementById('localFilename').textContent = '';
                
                // 重新初始化颜色选项
                initColorOptions();
                // 强制同步所有元素
                syncAllElementsTheme();
                
                // 更新引擎显示
                updateCurrentEngineText();
                setRandomWallpaper();
                document.getElementById('resetModal').style.display = 'none';
                alert('已恢复默认设置！');
            });
            document.getElementById('cancelReset').addEventListener('click', () => {
                document.getElementById('resetModal').style.display = 'none';
            });

            // 点击模态框外部关闭
            window.addEventListener('click', function(e) {
                const modals = ['engineModal', 'wallpaperModal', 'themeModal', 'resetModal'];
                modals.forEach(modalId => {
                    const modal = document.getElementById(modalId);
                    if (e.target === modal) {
                        modal.style.display = 'none';
                    }
                });
            });

            // 单选按钮选中时更新高亮和样式
            document.querySelectorAll('input[type="radio"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    updateSelectedHighlight();
                    // 如果是主题色单选框，实时预览样式
                    if (this.name === 'themeColor') {
                        // 获取临时深对比色
                        let tempDark = currentDarkColor;
                        for (const [name, [cls, code, darkCode]] of Object.entries(colorMap)) {
                            if (cls === this.value) {
                                tempDark = darkCode;
                                break;
                            }
                        }
                        // 临时更新单选框样式预览
                        const allRadios = document.querySelectorAll('.radio-option input[type="radio"]');
                        allRadios.forEach(r => {
                            r.style.border = `2px solid ${tempDark}`;
                            r.style.backgroundColor = r === this ? tempDark : 'transparent';
                        });
                    }
                });
            });
        }
    </script>
</body>
</html>
