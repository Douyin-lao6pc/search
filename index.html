<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>抖音-老六说电脑-定制浏览器主页</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'haze-blue': '#E0E9FF',
                        'mint-green': '#E6FFFA',
                        'cherry-pink': '#FFF0F5',
                        'avocado-green': '#E8F5E9',
                        'carbon-gray': '#1E293B',
                        'morandi-grayblue': '#94A3B8',
                        'milk-coffee': '#F5EFE7',
                        'haze-purple': '#DCD6F7',
                        'ice-fog-white': '#F8FAFC',
                        'milk-cream-yellow': '#FFFBEB',
                        'taro-purple': '#DED7F6',
                        'haze-gray': '#F1F5F9',
                        'mango-orange': '#FFF3E0',
                        'blueberry-jam': '#E3F2FD',
                        'grapefruit-red': '#FFE0E6'
                    },
                    animation: {
                        'ripple': 'ripple 0.6s ease-out',
                        'radio-pulse': 'radio-pulse 0.3s ease-out'
                    },
                    keyframes: {
                        ripple: {
                            '0%': { transform: 'scale(0.8)', opacity: 1 },
                            '100%': { transform: 'scale(1.2)', opacity: 0 }
                        },
                        'radio-pulse': {
                            '0%': { box-shadow: '0 0 0 0 #AA6666' },
                            '70%': { box-shadow: '0 0 0 8px transparent' },
                            '100%': { box-shadow: '0 0 0 0 transparent' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto', sans-serif;
        }
        body {
            min-height: 100vh;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            transition: background-color 0.3s ease, background-image 0.3s ease;
        }
        .capsule-btn {
            border-radius: 9999px;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border: 1px solid #000000;
            cursor: pointer;
            background: white/90;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .capsule-btn:active {
            transform: scale(0.98);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .ripple-container {
            position: relative;
            overflow: hidden;
        }
        .ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(255,255,255,0.6);
            transform: scale(0);
            animation: ripple 0.6s ease-out;
            pointer-events: none;
        }
        .search-input {
            border-radius: 9999px 0 0 9999px;
            border: 1px solid #000000;
            border-right: none;
            padding: 12px 20px;
            outline: none;
            font-size: 16px;
            width: 100%;
            max-width: 600px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .search-btn {
            border-radius: 0 9999px 9999px 0;
            border: 1px solid #000000;
            padding: 12px 24px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .search-btn:active {
            transform: scale(0.98);
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            border-radius: 16px;
            padding: 24px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            text-align: center;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s ease;
        }
        .modal-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 24px;
            transition: color 0.3s ease;
        }
        .radio-group {
            margin-bottom: 24px;
            text-align: left;
            flex: 1;
            overflow-y: auto;
            padding-right: 8px;
        }
        .radio-option {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border-radius: 12px;
            margin: 8px 0;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .radio-option:hover {
            background-color: rgba(0,0,0,0.05);
        }
        .radio-option.selected {
            background-color: rgba(0,0,0,0.1);
        }
        .refresh-btn {
            margin-right: 8px;
            padding: 4px;
            border-radius: 50%;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease;
        }
        .refresh-btn:hover {
            background-color: rgba(0,0,0,0.1);
        }
        .refresh-btn.show {
            display: flex;
        }
        .filename-label {
            font-size: 12px;
            color: #666;
            margin-left: 8px;
            max-width: 150px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .radio-option input[type="radio"] {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            outline: none;
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
        }
        .radio-option input[type="radio"]:checked {
            animation: radio-pulse 0.3s ease-out;
        }
        .radio-option input[type="radio"]:checked::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 8px;
            height: 8px;
            background-color: white;
            border-radius: 50%;
        }
        .modal-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: auto;
        }
        .modal-footer button {
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .modal-footer .cancel-btn {
            border: 1px solid;
            background: transparent;
        }
        .modal-footer .confirm-btn {
            border: 1px solid;
            background: transparent;
            font-weight: 500;
        }
        .modal-footer .cancel-btn:hover,
        .modal-footer .confirm-btn:hover {
            background-color: rgba(0,0,0,0.05);
        }
        .volume-control {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            padding: 0 8px;
        }
        .volume-control .material-icons {
            color: inherit;
            font-size: 20px;
        }
        .volume-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 4px;
            border-radius: 2px;
            background: rgba(0,0,0,0.2);
            outline: none;
        }
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: currentColor;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .volume-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }
        #localMusic, #localWallpaper {
            display: none;
        }
        /* 音乐播放暂停按钮样式 - 右下角悬浮 */
        .music-control-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transition: all 0.2s ease;
            z-index: 900;
        }
        .music-control-btn:active {
            transform: scale(0.95);
        }
        /* 折叠菜单核心样式 */
        .menu-container {
            position: absolute;
            top: 4px;
            left: 4px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .menu-toggle-btn {
            border-radius: 9999px;
            padding: 8px 16px;
            border: 1px solid #000;
            cursor: pointer;
            background: white/90;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
        }
        .menu-toggle-btn:active {
            transform: scale(0.98);
        }
        .menu-content {
            display: none;
            flex-direction: column;
            gap: 4px;
            margin-top: 4px;
        }
        .menu-content.show {
            display: flex;
        }
        /* 历史记录项样式 */
        .history-item {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            padding: 12px 16px;
            border-radius: 12px;
            margin: 8px 0;
            background-color: rgba(0,0,0,0.05);
            gap: 12px;
        }
        .history-item-info {
            flex: 1;
            text-align: left;
        }
        .history-content {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .history-meta {
            font-size: 12px;
            color: #666;
            display: flex;
            gap: 8px;
        }
        .history-delete-btn {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }
        .history-delete-btn:hover {
            background-color: rgba(0,0,0,0.1);
        }
        .history-empty {
            text-align: center;
            padding: 24px 0;
            font-size: 14px;
            color: #666;
        }
        @media (max-width: 768px) {
            .time-display {
                font-size: 4rem !important;
            }
            .search-input {
                max-width: 400px;
            }
        }
    </style>
    <link rel="icon" href="icon.ico" type="image/x-icon">
</head>
<body class="cherry-pink/30">
    <!-- 左上角折叠菜单 - 新增历史记录按钮 -->
    <div class="menu-container">
        <button class="menu-toggle-btn ripple-container" id="menuToggleBtn" style="background-color: #FFF0F5;">
            <span class="material-icons">menu</span>
            <span id="menuToggleText">打开菜单</span>
        </button>
        <div class="menu-content" id="menuContent">
            <button class="capsule-btn ripple-container" id="wallpaperBtn" style="background-color: #FFF0F5;">
                <span class="material-icons">wallpaper</span>
                <span>壁纸</span>
            </button>
            <button class="capsule-btn ripple-container" id="themeBtn" style="background-color: #FFF0F5;">
                <span class="material-icons">palette</span>
                <span>主题颜色</span>
            </button>
            <button class="capsule-btn ripple-container" id="musicBtn" style="background-color: #FFF0F5;">
                <span class="material-icons">music_note</span>
                <span>背景音乐</span>
            </button>
            <button class="capsule-btn ripple-container" id="aboutBtn" style="background-color: #FFF0F5;">
                <span class="material-icons">info</span>
                <span>关于</span>
            </button>
            <!-- 新增：历史记录按钮（恢复默认上方） -->
            <button class="capsule-btn ripple-container" id="historyBtn" style="background-color: #FFF0F5;">
                <span class="material-icons">history</span>
                <span>历史记录</span>
            </button>
            <button class="capsule-btn ripple-container" id="resetBtn" style="background-color: #FFF0F5;">
                <span class="material-icons">restore</span>
                <span>恢复默认</span>
            </button>
        </div>
    </div>

    <!-- 右下角音乐播放/暂停控制按钮 -->
    <div class="music-control-btn ripple-container" id="musicControlBtn" style="background-color: #FFF0F5; display: none;">
        <span class="material-icons" style="color: #AA6666; font-size: 24px;" id="musicControlIcon">play_arrow</span>
    </div>

    <!-- 页面核心内容区（时间、日期、搜索）- 保留原有点击容器 -->
    <div class="flex flex-col items-center justify-center min-h-screen px-4">
        <div class="cursor-pointer" id="dateTimeContainer" style="user-select: none;">
            <div class="time-display text-7xl font-bold text-gray-800 mb-2" id="time">00:00:00</div>
            <div class="text-lg text-gray-700 mb-8 text-center" id="date">2026/01/27        星期二</div>
        </div>
        
        <div class="w-full max-w-2xl mb-4">
            <div class="flex items-center justify-center">
                <input type="text" class="search-input" id="searchInput" placeholder="请输入搜索内容或网址...">
                <button class="search-btn ripple-container" id="searchBtn" style="background-color: #FFF0F5;">
                    <span class="material-icons" id="searchIcon">search</span>
                </button>
            </div>
            <div class="mt-4 flex flex-col items-center">
                <button class="capsule-btn ripple-container" id="engineBtn" style="background-color: #FFF0F5;">
                    <span class="material-icons">search</span>
                    <span id="currentEngineText">当前搜索引擎：微软必应-国内版</span>
                </button>
            </div>
        </div>
    </div>

    <!-- 搜索引擎选择弹窗 -->
    <div class="modal" id="engineModal">
        <div class="modal-content" style="background-color: #FFF0F5;">
            <div class="modal-title" style="color: #AA6666;">选择搜索引擎</div>
            <div class="radio-group">
                <label class="radio-option ripple-container selected" id="bingCnOption">
                    <span>微软必应-国内版</span>
                    <input type="radio" name="engine" value="bing-cn" checked style="border: 2px solid #AA6666; background-color: #AA6666;">
                </label>
                <label class="radio-option ripple-container" id="bingIntlOption">
                    <span>微软必应-国际版</span>
                    <input type="radio" name="engine" value="bing-intl" style="border: 2px solid #AA6666; background-color: transparent;">
                </label>
                <label class="radio-option ripple-container" id="googleOption">
                    <span>Google</span>
                    <input type="radio" name="engine" value="google" style="border: 2px solid #AA6666; background-color: transparent;">
                </label>
                <label class="radio-option ripple-container" id="baiduOption">
                    <span>百度</span>
                    <input type="radio" name="engine" value="baidu" style="border: 2px solid #AA6666; background-color: transparent;">
                </label>
                <label class="radio-option ripple-container" id="360Option">
                    <span>360</span>
                    <input type="radio" name="engine" value="360" style="border: 2px solid #AA6666; background-color: transparent;">
                </label>
                <label class="radio-option ripple-container" id="sogouOption">
                    <span>搜狗</span>
                    <input type="radio" name="engine" value="sogou" style="border: 2px solid #AA6666; background-color: transparent;">
                </label>
            </div>
            <div class="modal-footer">
                <button class="cancel-btn" style="border-color: #AA6666; color: #AA6666;" id="closeEngineModal">取消</button>
                <button class="confirm-btn" style="border-color: #AA6666; color: #AA6666;" id="confirmEngine">确认</button>
            </div>
        </div>
    </div>

    <!-- 壁纸设置弹窗 -->
    <div class="modal" id="wallpaperModal">
        <div class="modal-content" style="background-color: #FFF0F5;">
            <div class="modal-title" style="color: #AA6666;">壁纸设置</div>
            <div class="radio-group">
                <label class="radio-option ripple-container" id="noneWallpaperOption">
                    <span>无壁纸（使用主题色）</span>
                    <input type="radio" name="wallpaperType" value="none" style="border: 2px solid #AA6666; background-color: transparent;">
                </label>
                <label class="radio-option ripple-container selected" id="networkWallpaperOption">
                    <span class="refresh-btn" id="refreshWallpaperBtn">
                        <span class="material-icons" style="font-size: 16px; color: #AA6666;">refresh</span>
                    </span>
                    <span>网络壁纸（随机）</span>
                    <input type="radio" name="wallpaperType" value="network" checked style="border: 2px solid #AA6666; background-color: #AA6666;">
                </label>
                <label class="radio-option ripple-container" id="localWallpaperOption">
                    <span>本地图片</span>
                    <span class="filename-label" id="localFilename"></span>
                    <input type="radio" name="wallpaperType" value="local" style="border: 2px solid #AA6666; background-color: transparent;">
                </label>
            </div>
            <input type="file" id="localWallpaper" accept="image/*" class="hidden mt-2">
            <div class="modal-footer">
                <button class="cancel-btn" style="border-color: #AA6666; color: #AA6666;" id="closeWallpaperModal">取消</button>
                <button class="confirm-btn" style="border-color: #AA6666; color: #AA6666;" id="confirmWallpaper">确认</button>
            </div>
        </div>
    </div>

    <!-- 主题颜色设置弹窗 -->
    <div class="modal" id="themeModal">
        <div class="modal-content" style="background-color: #FFF0F5;">
            <div class="modal-title" style="color: #AA6666;">Google原生Android主题色</div>
            <div class="radio-group" id="colorOptions">
            </div>
            <div class="modal-footer">
                <button class="cancel-btn" style="border-color: #AA6666; color: #AA6666;" id="closeThemeModal">取消</button>
                <button class="confirm-btn" style="border-color: #AA6666; color: #AA6666;" id="confirmTheme">确认</button>
            </div>
        </div>
    </div>

    <!-- 背景音乐设置弹窗 -->
    <div class="modal" id="musicModal">
        <div class="modal-content" style="background-color: #FFF0F5;">
            <div class="modal-title" style="color: #AA6666;">背景音乐设置</div>
            <div class="radio-group">
                <label class="radio-option ripple-container selected" id="noneMusicOption">
                    <span>无背景音乐</span>
                    <input type="radio" name="musicType" value="none" checked style="border: 2px solid #AA6666; background-color: #AA6666;">
                </label>
                <label class="radio-option ripple-container" id="defaultMusicOption">
                    <span>默认背景音乐</span>
                    <input type="radio" name="musicType" value="default" style="border: 2px solid #AA6666; background-color: transparent;">
                </label>
                <label class="radio-option ripple-container" id="localMusicOption">
                    <span>本地音乐</span>
                    <span class="filename-label" id="localMusicName"></span>
                    <input type="radio" name="musicType" value="local" style="border: 2px solid #AA6666; background-color: transparent;">
                </label>
            </div>
            <div class="volume-control">
                <span class="material-icons">volume_up</span>
                <input type="range" class="volume-slider" id="volumeSlider" min="0" max="1" step="0.05" value="0.5" style="color: #AA6666;">
            </div>
            <input type="file" id="localMusic" accept="audio/*" class="hidden">
            <div class="modal-footer">
                <button class="cancel-btn" style="border-color: #AA6666; color: #AA6666;" id="closeMusicModal">取消</button>
                <button class="confirm-btn" style="border-color: #AA6666; color: #AA6666;" id="confirmMusic">确认</button>
            </div>
        </div>
    </div>

    <!-- 新增：历史记录弹窗（样式与其他弹窗完全统一） -->
    <div class="modal" id="historyModal">
        <div class="modal-content" style="background-color: #FFF0F5;">
            <div class="modal-title" style="color: #AA6666;">搜索历史记录</div>
            <!-- 历史记录列表容器（复用radio-group的滚动/布局样式） -->
            <div class="radio-group" id="historyList" style="margin-bottom: 16px;">
                <!-- 历史记录项由JS动态生成 -->
            </div>
            <div class="modal-footer">
                <button class="cancel-btn" style="border-color: #AA6666; color: #AA6666;" id="closeHistoryModal">关闭</button>
                <button class="confirm-btn" style="border-color: #AA6666; color: #AA6666;" id="clearAllHistory">清空全部</button>
            </div>
        </div>
    </div>

    <!-- 音乐权限受限提示弹窗 -->
    <div class="modal" id="musicPermissionModal">
        <div class="modal-content" style="background-color: #FFF0F5;">
            <div class="modal-title" style="color: #AA6666;">浏览器权限提示</div>
            <div style="color: #AA6666; margin-bottom: 24px; font-size: 14px; line-height: 1.5;">
                因浏览器自动播放权限受限，背景音乐无法自动启动，请手动选择以下操作
            </div>
            <div class="modal-footer">
                <button class="cancel-btn" style="border-color: #AA6666; color: #AA6666;" id="musicPermissionCancel">不播放并关闭</button>
                <button class="confirm-btn" style="border-color: #AA6666; color: #AA6666;" id="musicPermissionConfirm">开始播放并关闭</button>
            </div>
        </div>
    </div>

    <!-- 恢复默认设置确认弹窗 -->
    <div class="modal" id="resetModal">
        <div class="modal-content" style="background-color: #FFF0F5;">
            <div class="modal-title" style="color: #AA6666;">确认恢复默认设置？</div>
            <div class="modal-footer">
                <button class="cancel-btn" style="border-color: #AA6666; color: #AA6666;" id="cancelReset">否</button>
                <button class="confirm-btn" style="border-color: #AA6666; color: #AA6666;" id="confirmReset">是</button>
            </div>
        </div>
    </div>

    <script>
        // 全局状态变量 - 新增历史记录相关
        let currentEngine = 'bing-cn';
        let currentTheme = 'cherry-pink';
        let currentThemeColor = '#FFF0F5';
        let currentDarkColor = '#AA6666';
        let wallpaperType = 'network';
        let wallpaperUrl = '';
        let localFileName = '';
        let localFileBase64 = '';
        let localMusicFileName = '';
        let localMusicBase64 = '';
        let musicType = 'none';
        let musicVolume = 0.5;
        let audioPlayer = new Audio();
        let userInteracted = false;
        let isMusicPlaying = false;
        let isMenuOpen = false;
        let searchHistory = []; // 新增：搜索历史数组

        // 搜索引擎配置
        const engineConfig = {
            'bing-cn': { name: '微软必应-国内版', searchUrl: 'https://cn.bing.com/search?q=', testUrl: 'https://cn.bing.com/favicon.ico', isUnreachable: false },
            'bing-intl': { name: '微软必应-国际版', searchUrl: 'https://www.bing.com/search?q=', testUrl: 'https://www.bing.com/favicon.ico', isUnreachable: false },
            'google': { name: 'Google', searchUrl: 'https://www.google.com/search?q=', testUrl: 'https://www.google.com/favicon.ico' },
            'baidu': { name: '百度', searchUrl: 'https://www.baidu.com/s?wd=', testUrl: 'https://www.baidu.com/favicon.ico', isUnreachable: false },
            '360': { name: '360', searchUrl: 'https://www.so.com/s?q=', testUrl: 'https://www.so.com/favicon.ico', isUnreachable: false },
            'sogou': { name: '搜狗', searchUrl: 'https://www.sogou.com/web?query=', testUrl: 'https://www.sogou.com/favicon.ico', isUnreachable: false }
        };

        // 主题颜色配置
        const colorMap = {
            '雾霾蓝': ['haze-blue', '#E0E9FF', '#8099CC'],
            '薄荷绿': ['mint-green', '#E6FFFA', '#86CCCC'],
            '樱花粉': ['cherry-pink', '#FFF0F5', '#AA6666'],
            '牛油果绿': ['avocado-green', '#E8F5E9', '#88B599'],
            '碳灰色': ['carbon-gray', '#1E293B', '#0E192B'],
            '莫兰迪灰蓝': ['morandi-grayblue', '#94A3B8', '#546378'],
            '奶咖色': ['milk-coffee', '#F5EFE7', '#A58E77'],
            '雾霾紫': ['haze-purple', '#DCD6F7', '#8C86B7'],
            '冰雾白': ['ice-fog-white', '#F8FAFC', '#A8B0B4'],
            '奶霜黄': ['milk-cream-yellow', '#FFFBEB', '#BB996B'],
            '芋泥紫': ['taro-purple', '#DED7F6', '#8E87B6'],
            '雾霾灰': ['haze-gray', '#F1F5F9', '#A1A5B9'],
            '芒果橙': ['mango-orange', '#FFF3E0', '#BB9380'],
            '蓝莓酱': ['blueberry-jam', '#E3F2FD', '#83A2CD'],
            '西柚红': ['grapefruit-red', '#FFE0E6', '#BB7076']
        };

        // 页面加载完成初始化
        document.addEventListener('DOMContentLoaded', function() {
            document.addEventListener('click', markUserInteraction);
            document.addEventListener('touchstart', markUserInteraction);
            
            // 时间日期区域单击跳转事件
            document.getElementById('dateTimeContainer').addEventListener('click', function() {
                window.location.href = 'https://douyin-lao6pc.github.io/search/date.html';
            });
            
            init();
            loadLocalWallpaperIfExists();
            loadLocalMusicIfExists();
            checkMusicModeAndShowPermissionModal();
            bindMenuEvents();
            bindSearchInputListener();
            loadSearchHistory(); // 新增：加载历史记录
            renderSearchHistory(); // 新增：渲染历史记录
        });

        // 标记用户已完成首次交互
        function markUserInteraction() {
            if (!userInteracted) {
                userInteracted = true;
            }
        }

        // 检测音乐模式，若为默认/本地音乐则弹出权限提示
        function checkMusicModeAndShowPermissionModal() {
            if ((musicType === 'default' || musicType === 'local') && (localMusicBase64 || musicType === 'default')) {
                document.getElementById('musicPermissionModal').style.display = 'flex';
                document.getElementById('musicControlBtn').style.display = 'flex';
            }
        }

        // 文件转Base64
        function fileToBase64(file, callback) {
            const reader = new FileReader();
            reader.onload = function(e) {
                callback(e.target.result);
            };
            reader.onerror = function() {
                alert('文件读取失败，请选择有效文件！');
                callback(null);
            };
            reader.readAsDataURL(file);
        }

        // 全局初始化
        function init() {
            loadSettings();
            initColorOptions();
            syncAllElementsTheme();
            updateTimeDate();
            setInterval(updateTimeDate, 1000);
            if (wallpaperType === 'network' && !localFileBase64) {
                setRandomWallpaper(false);
                showRefreshBtn(true);
            } else if (wallpaperType === 'none') {
                setNoWallpaper();
            }
            updateCurrentEngineText();
            bindEvents();
            audioPlayer.volume = musicVolume;
            audioPlayer.loop = true;
            document.getElementById('volumeSlider').value = musicVolume;
            updateMusicControlButton();
            bindHistoryEvents(); // 新增：绑定历史记录相关事件
        }

        // 加载本地壁纸
        function loadLocalWallpaperIfExists() {
            if (wallpaperType === 'local' && localFileBase64) {
                document.body.style.backgroundImage = `url(${localFileBase64})`;
                document.body.style.backgroundColor = '';
                document.querySelector('input[name="wallpaperType"][value="local"]').checked = true;
                document.querySelector('input[name="wallpaperType"][value="network"]').checked = false;
                updateSelectedHighlight();
                showRefreshBtn(false);
                document.getElementById('localFilename').textContent = localFileName;
            }
        }

        // 加载本地音乐
        function loadLocalMusicIfExists() {
            if (musicType === 'local' && localMusicBase64) {
                document.querySelector('input[name="musicType"][value="local"]').checked = true;
                document.querySelector('input[name="musicType"][value="none"]').checked = false;
                updateSelectedHighlight();
                document.getElementById('localMusicName').textContent = localMusicFileName;
                audioPlayer.src = localMusicBase64;
                document.getElementById('musicControlBtn').style.display = 'flex';
            } else if (musicType === 'default') {
                document.querySelector('input[name="musicType"][value="default"]').checked = true;
                document.querySelector('input[name="musicType"][value="none"]').checked = false;
                updateSelectedHighlight();
                audioPlayer.src = 'music.mp3';
                document.getElementById('musicControlBtn').style.display = 'flex';
            }
        }

        // 播放音乐（带权限校验）
        function playMusic() {
            if (userInteracted && (musicType === 'default' || musicType === 'local')) {
                audioPlayer.play().then(() => {
                    isMusicPlaying = true;
                    updateMusicControlButton();
                }).catch(err => {
                    console.log('音乐播放失败:', err);
                    alert('音乐播放失败，请检查文件或重试！');
                });
            }
        }

        // 暂停音乐
        function pauseMusic() {
            audioPlayer.pause();
            isMusicPlaying = false;
            updateMusicControlButton();
        }

        // 更新播放/暂停按钮状态
        function updateMusicControlButton() {
            const icon = document.getElementById('musicControlIcon');
            icon.textContent = isMusicPlaying ? 'pause' : 'play_arrow';
            document.getElementById('musicControlBtn').style.backgroundColor = currentThemeColor;
            icon.style.color = currentDarkColor;
        }

        // 同步所有元素主题颜色 - 新增同步历史记录弹窗
        function syncAllElementsTheme() {
            document.body.className = `${currentTheme}/30`;
            if (wallpaperType === 'none') {
                document.body.style.backgroundColor = currentThemeColor;
            } else {
                document.body.style.backgroundColor = '';
            }

            const functionBtns = [
                document.getElementById('wallpaperBtn'),
                document.getElementById('themeBtn'),
                document.getElementById('musicBtn'),
                document.getElementById('aboutBtn'),
                document.getElementById('historyBtn'), // 新增：历史记录按钮
                document.getElementById('resetBtn'),
                document.getElementById('engineBtn'),
                document.getElementById('searchBtn'),
                document.getElementById('menuToggleBtn')
            ];
            functionBtns.forEach(btn => {
                if (btn) btn.style.backgroundColor = currentThemeColor;
            });

            const modals = document.querySelectorAll('.modal-content');
            const modalTitles = document.querySelectorAll('.modal-title');
            const modalTexts = document.querySelectorAll('.radio-option span:not(.filename-label):not(.material-icons), .history-item-info *'); // 新增：历史记录文本
            const modalBtns = document.querySelectorAll('.modal-footer button');
            const allRadios = document.querySelectorAll('.radio-option input[type="radio"]');
            const volumeSlider = document.getElementById('volumeSlider');
            const searchIcon = document.getElementById('searchIcon');
            const historyDeleteIcons = document.querySelectorAll('.history-delete-btn .material-icons'); // 新增：历史记录删除图标

            modals.forEach(modal => modal.style.backgroundColor = currentThemeColor);
            modalTitles.forEach(title => title.style.color = currentDarkColor);
            modalTexts.forEach(text => text.style.color = currentDarkColor);
            modalBtns.forEach(btn => {
                btn.style.borderColor = currentDarkColor;
                btn.style.color = currentDarkColor;
            });
            allRadios.forEach(radio => {
                radio.style.border = `2px solid ${currentDarkColor}`;
                radio.style.backgroundColor = radio.checked ? currentDarkColor : 'transparent';
            });
            volumeSlider.style.color = currentDarkColor;
            searchIcon.style.color = currentDarkColor;
            historyDeleteIcons.forEach(icon => icon.style.color = currentDarkColor); // 新增：同步删除图标颜色

            document.styleSheets[1].cssRules[1].style.boxShadow = `0 0 0 0 ${currentDarkColor}`;
            updateSelectedHighlight();
            updateMusicControlButton();
        }

        // 显示/隐藏壁纸刷新按钮
        function showRefreshBtn(show) {
            const refreshBtn = document.getElementById('refreshWallpaperBtn');
            show ? refreshBtn.classList.add('show') : refreshBtn.classList.remove('show');
        }

        // 颜色加深工具函数
        function darkenColor(hex, percent = 50) {
            hex = hex.replace(/^#/, '');
            let r = parseInt(hex.substring(0, 2), 16);
            let g = parseInt(hex.substring(2, 4), 16);
            let b = parseInt(hex.substring(4, 6), 16);
            r = Math.floor(r * (1 - percent / 100));
            g = Math.floor(g * (1 - percent / 100));
            b = Math.floor(b * (1 - percent / 100));
            return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
        }

        // 更新时间和日期
        function updateTimeDate() {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            document.getElementById('time').textContent = `${hours}:${minutes}:${seconds}`;
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            const weekDays = ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'];
            document.getElementById('date').textContent = `${year}/${month}/${day}        ${weekDays[now.getDay()]}`;
        }

        // 更新当前搜索引擎文本
        function updateCurrentEngineText() {
            document.getElementById('currentEngineText').textContent = `当前搜索引擎：${engineConfig[currentEngine].name}`;
        }

        // 设置随机网络壁纸
        function setRandomWallpaper(isSave = true) {
            const width = screen.width;
            const height = screen.height;
            wallpaperUrl = `https://picsum.photos/${width}/${height}?random=${Date.now()}`;
            document.body.style.backgroundImage = `url(${wallpaperUrl})`;
            document.body.style.backgroundColor = '';
            if (isSave) {
                wallpaperType = 'network';
                localFileBase64 = '';
                localFileName = '';
                saveSettings();
            }
            adjustTextColorForBackground();
        }

        // 关闭壁纸，使用主题色
        function setNoWallpaper() {
            document.body.style.backgroundImage = 'none';
            document.body.style.backgroundColor = currentThemeColor;
            wallpaperType = 'none';
            localFileBase64 = '';
            localFileName = '';
            saveSettings();
            adjustTextColorForBackground();
        }

        // 初始化主题颜色选项
        function initColorOptions() {
            const colorContainer = document.getElementById('colorOptions');
            colorContainer.innerHTML = '';
            for (const [colorName, [colorClass, colorCode, darkCode]] of Object.entries(colorMap)) {
                const isSelected = colorClass === currentTheme;
                const radioOption = document.createElement('label');
                radioOption.className = `radio-option ripple-container ${isSelected ? 'selected' : ''}`;
                const span = document.createElement('span');
                span.textContent = `${colorName}（${colorCode}）`;
                span.style.color = currentDarkColor;
                const radio = document.createElement('input');
                radio.type = 'radio';
                radio.name = 'themeColor';
                radio.value = colorClass;
                radio.checked = isSelected;
                radio.style.border = `2px solid ${currentDarkColor}`;
                radio.style.backgroundColor = isSelected ? currentDarkColor : 'transparent';
                radioOption.appendChild(span);
                radioOption.appendChild(radio);
                colorContainer.appendChild(radioOption);
            }
        }

        // 应用选中的主题颜色
        function applyTheme() {
            const selectedRadio = document.querySelector('input[name="themeColor"]:checked');
            if (!selectedRadio) return;
            const selectedClass = selectedRadio.value;
            for (const [name, [cls, code, darkCode]] of Object.entries(colorMap)) {
                if (cls === selectedClass) {
                    currentTheme = cls;
                    currentThemeColor = code;
                    currentDarkColor = darkCode;
                    break;
                }
            }
            syncAllElementsTheme();
            saveSettings();
            adjustTextColorForBackground();
        }

        // 根据背景调整文字颜色
        function adjustTextColorForBackground() {
            const timeElement = document.getElementById('time');
            const dateElement = document.getElementById('date');
            const computedStyle = window.getComputedStyle(document.body);
            const bgImage = computedStyle.backgroundImage;
            
            if (bgImage !== 'none') {
                const img = new Image();
                img.crossOrigin = 'Anonymous';
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = 1;
                    canvas.height = 1;
                    ctx.drawImage(img, 0, 0, 1, 1);
                    const pixel = ctx.getImageData(0, 0, 1, 1).data;
                    const brightness = (0.299 * pixel[0] + 0.587 * pixel[1] + 0.114 * pixel[2]) / 255;
                    timeElement.style.color = brightness < 0.5 ? 'white' : 'black';
                    dateElement.style.color = brightness < 0.5 ? 'white' : 'black';
                };
                img.src = bgImage.replace(/^url\(["']?/, '').replace(/["']?\)$/, '');
            } else {
                const rgb = currentThemeColor.match(/\d+/g) || [255,255,255];
                const brightness = (0.299 * rgb[0] + 0.587 * rgb[1] + 0.114 * rgb[2]) / 255;
                timeElement.style.color = brightness < 0.5 ? 'white' : 'black';
                dateElement.style.color = brightness < 0.5 ? 'white' : 'black';
            }
        }

        // 网址验证正则（支持带/不带http(s)、带/不带www的域名/IP）
        function isUrl(str) {
            const urlRegex = /^(https?:\/\/)?([\w-]+\.)+[\w-]+(\/[\w-./?%&=]*)?$|^\d{1,3}(\.\d{1,3}){3}(:\d+)?(\/.*)?$/;
            return urlRegex.test(str.trim());
        }

        // 补全网址协议（无http/https时自动添加https）
        function completeUrl(url) {
            const trimmedUrl = url.trim();
            if (!/^https?:\/\//i.test(trimmedUrl)) {
                return `https://${trimmedUrl}`;
            }
            return trimmedUrl;
        }

        // 新增：记录搜索历史
        function recordSearchHistory(content) {
            const trimmedContent = content.trim();
            if (!trimmedContent) return;
            // 判定类型：网址/文字搜索
            const type = isUrl(trimmedContent) ? '网址' : '文字搜索';
            // 获取当前时间（格式化：YYYY/MM/DD HH:mm:ss）
            const now = new Date();
            const time = `${now.getFullYear()}/${(now.getMonth()+1).toString().padStart(2, '0')}/${now.getDate().toString().padStart(2, '0')} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
            // 获取当前搜索引擎名称
            const engine = engineConfig[currentEngine].name;
            // 生成历史记录项（带唯一ID，用于删除）
            const historyItem = {
                id: Date.now() + Math.random().toString(36).substr(2, 5), // 唯一ID
                content: trimmedContent,
                type,
                time,
                engine
            };
            // 加入历史记录（头部添加，最新的在最前面）
            searchHistory.unshift(historyItem);
            // 保存并重新渲染
            saveSearchHistory();
            renderSearchHistory();
        }

        // 新增：保存搜索历史到本地存储
        function saveSearchHistory() {
            localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
        }

        // 新增：从本地存储加载搜索历史
        function loadSearchHistory() {
            const saved = localStorage.getItem('searchHistory');
            if (saved) {
                searchHistory = JSON.parse(saved) || [];
            }
        }

        // 新增：渲染搜索历史列表
        function renderSearchHistory() {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';
            // 无历史记录时显示提示
            if (searchHistory.length === 0) {
                const emptyTip = document.createElement('div');
                emptyTip.className = 'history-empty';
                emptyTip.style.color = currentDarkColor;
                emptyTip.textContent = '暂无搜索历史记录';
                historyList.appendChild(emptyTip);
                return;
            }
            // 遍历生成历史记录项
            searchHistory.forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item ripple-container';
                historyItem.dataset.id = item.id; // 绑定唯一ID

                // 信息区域
                const infoDiv = document.createElement('div');
                infoDiv.className = 'history-item-info';

                const contentSpan = document.createElement('div');
                contentSpan.className = 'history-content';
                contentSpan.textContent = item.content;

                const metaSpan = document.createElement('div');
                metaSpan.className = 'history-meta';
                metaSpan.innerHTML = `<span>类型：${item.type}</span><span>引擎：${item.engine}</span><span>时间：${item.time}</span>`;

                infoDiv.appendChild(contentSpan);
                infoDiv.appendChild(metaSpan);

                // 删除按钮
                const deleteBtn = document.createElement('div');
                deleteBtn.className = 'history-delete-btn ripple-container';
                deleteBtn.innerHTML = `<span class="material-icons" style="font-size: 16px; color: ${currentDarkColor};">delete</span>`;
                // 绑定单条删除事件
                deleteBtn.addEventListener('click', function(e) {
                    e.stopPropagation(); // 阻止冒泡触发波纹效果
                    deleteSingleHistory(item.id);
                });

                // 历史项点击事件：将内容填入搜索框
                historyItem.addEventListener('click', function() {
                    document.getElementById('searchInput').value = item.content;
                    document.getElementById('historyModal').style.display = 'none';
                    // 同步更新搜索图标
                    const searchIcon = document.getElementById('searchIcon');
                    searchIcon.textContent = isUrl(item.content) ? 'arrow_forward' : 'search';
                });

                historyItem.appendChild(infoDiv);
                historyItem.appendChild(deleteBtn);
                historyList.appendChild(historyItem);
            });
        }

        // 新增：删除单条历史记录
        function deleteSingleHistory(id) {
            // 过滤掉对应ID的项
            searchHistory = searchHistory.filter(item => item.id !== id);
            // 保存并重新渲染
            saveSearchHistory();
            renderSearchHistory();
        }

        // 新增：清空全部历史记录
        function clearAllHistory() {
            if (confirm('确定要清空所有搜索历史记录吗？此操作不可恢复！')) {
                searchHistory = [];
                saveSearchHistory();
                renderSearchHistory();
            }
        }

        // 优化搜索功能：智能识别网址/关键词 + 新增记录历史
        function search() {
            const keyword = document.getElementById('searchInput').value.trim();
            if (!keyword) {
                alert('请输入搜索内容或网址！');
                return;
            }

            // 新增：先记录历史，再处理跳转
            recordSearchHistory(keyword);

            // 识别为网址：直接跳转
            if (isUrl(keyword)) {
                const fullUrl = completeUrl(keyword);
                window.open(fullUrl, '_self');
                return;
            }

            // 识别为关键词：走原搜索引擎逻辑
            const engine = engineConfig[currentEngine];
            if (currentEngine === 'google') {
                if (confirm('谷歌暂不支持中国大陆直接访问，如需访问请配置网络代理！')) {
                    window.open(`${engine.searchUrl}${encodeURIComponent(keyword)}`, '_self');
                }
            } else {
                if (engine.isUnreachable) {
                    alert(`${engine.name}在当前网络环境下无法访问，请选择其他搜索引擎！`);
                    return;
                }
                window.open(`${engine.searchUrl}${encodeURIComponent(keyword)}`, '_self');
            }
        }

        // 绑定搜索栏输入监听，实时切换图标
        function bindSearchInputListener() {
            const searchInput = document.getElementById('searchInput');
            const searchIcon = document.getElementById('searchIcon');

            searchInput.addEventListener('input', function() {
                const value = this.value.trim();
                if (value && isUrl(value)) {
                    searchIcon.textContent = 'arrow_forward';
                } else {
                    searchIcon.textContent = 'search';
                }
            });

            searchInput.addEventListener('blur', function() {
                if (!this.value.trim()) {
                    searchIcon.textContent = 'search';
                }
            });
        }

        // 保存设置到本地存储 - 恢复默认时清空历史记录
        function saveSettings() {
            const settings = {
                currentEngine,
                currentTheme,
                currentThemeColor,
                currentDarkColor,
                wallpaperType,
                wallpaperUrl,
                localFileName,
                localFileBase64,
                musicType,
                localMusicFileName,
                localMusicBase64,
                musicVolume,
                isMenuOpen
            };
            localStorage.setItem('browserHomeSettings', JSON.stringify(settings));
        }

        // 从本地存储加载设置
        function loadSettings() {
            const saved = localStorage.getItem('browserHomeSettings');
            if (saved) {
                const settings = JSON.parse(saved);
                currentEngine = settings.currentEngine || 'bing-cn';
                currentTheme = settings.currentTheme || 'cherry-pink';
                currentThemeColor = settings.currentThemeColor || '#FFF0F5';
                currentDarkColor = settings.currentDarkColor || '#AA6666';
                wallpaperType = settings.wallpaperType || 'network';
                wallpaperUrl = settings.wallpaperUrl || '';
                localFileName = settings.localFileName || '';
                localFileBase64 = settings.localFileBase64 || '';
                musicType = settings.musicType || 'none';
                localMusicFileName = settings.localMusicFileName || '';
                localMusicBase64 = settings.localMusicBase64 || '';
                musicVolume = settings.musicVolume || 0.5;
                isMenuOpen = settings.isMenuOpen || false;

                document.querySelector(`input[name="engine"][value="${currentEngine}"]`).checked = true;
                document.querySelector(`input[name="wallpaperType"][value="${wallpaperType}"]`).checked = true;
                document.querySelector(`input[name="musicType"][value="${musicType}"]`).checked = true;
                document.getElementById('localFilename').textContent = localFileName;
                document.getElementById('localMusicName').textContent = localMusicFileName;

                if (isMenuOpen) {
                    document.getElementById('menuContent').classList.add('show');
                    document.getElementById('menuToggleText').textContent = '关闭菜单';
                    document.querySelector('#menuToggleBtn .material-icons').textContent = 'close';
                }

                updateCurrentEngineText();
                if (wallpaperType === 'network' && !localFileBase64) {
                    document.body.style.backgroundImage = `url(${wallpaperUrl})`;
                } else if (wallpaperType === 'none') {
                    document.body.style.backgroundImage = 'none';
                    document.body.style.backgroundColor = currentThemeColor;
                }
            }
        }

        // 更新单选框选中高亮
        function updateSelectedHighlight() {
            document.querySelectorAll('.radio-option').forEach(option => {
                option.classList.remove('selected');
                if (option.querySelector('input:checked')) {
                    option.classList.add('selected');
                }
            });
        }

        // 折叠菜单专属事件绑定
        function bindMenuEvents() {
            const menuToggleBtn = document.getElementById('menuToggleBtn');
            const menuContent = document.getElementById('menuContent');
            const menuToggleText = document.getElementById('menuToggleText');
            const menuIcon = menuToggleBtn.querySelector('.material-icons');

            menuToggleBtn.addEventListener('click', function() {
                isMenuOpen = !isMenuOpen;
                if (isMenuOpen) {
                    menuContent.classList.add('show');
                    menuToggleText.textContent = '关闭菜单';
                    menuIcon.textContent = 'close';
                } else {
                    menuContent.classList.remove('show');
                    menuToggleText.textContent = '打开菜单';
                    menuIcon.textContent = 'menu';
                }
                saveSettings();
            });

            window.addEventListener('click', function(e) {
                const menuContainer = document.querySelector('.menu-container');
                if (!menuContainer.contains(e.target) && isMenuOpen) {
                    isMenuOpen = false;
                    menuContent.classList.remove('show');
                    menuToggleText.textContent = '打开菜单';
                    menuIcon.textContent = 'menu';
                    saveSettings();
                }
            });
        }

        // 新增：历史记录专属事件绑定
        function bindHistoryEvents() {
            // 打开历史记录弹窗
            document.getElementById('historyBtn').addEventListener('click', function() {
                renderSearchHistory(); // 每次打开重新渲染，保证最新
                document.getElementById('historyModal').style.display = 'flex';
            });
            // 关闭历史记录弹窗
            document.getElementById('closeHistoryModal').addEventListener('click', function() {
                document.getElementById('historyModal').style.display = 'none';
            });
            // 清空全部历史记录
            document.getElementById('clearAllHistory').addEventListener('click', clearAllHistory);
        }

        // 绑定所有页面其他事件
        function bindEvents() {
            // 波纹效果事件
            document.querySelectorAll('.ripple-container').forEach(container => {
                container.addEventListener('click', function(e) {
                    const ripple = document.createElement('span');
                    const rect = this.getBoundingClientRect();
                    const size = Math.max(rect.width, rect.height);
                    ripple.className = 'ripple';
                    ripple.style.width = ripple.style.height = `${size}px`;
                    ripple.style.left = `${e.clientX - rect.left - size/2}px`;
                    ripple.style.top = `${e.clientY - rect.top - size/2}px`;
                    this.appendChild(ripple);
                    setTimeout(() => ripple.remove(), 600);
                });
            });

            // 关于按钮
            document.getElementById('aboutBtn').addEventListener('click', () => {
                alert('抖音-老六说电脑-定制浏览器主页 v1.1\n开发者：抖音-老六说电脑\n官网：https://douyin-lao6pc.github.io/web');
            });

            // 搜索引擎弹窗事件
            document.getElementById('engineBtn').addEventListener('click', () => document.getElementById('engineModal').style.display = 'flex');
            document.getElementById('closeEngineModal').addEventListener('click', () => document.getElementById('engineModal').style.display = 'none');
            document.getElementById('confirmEngine').addEventListener('click', () => {
                currentEngine = document.querySelector('input[name="engine"]:checked').value;
                updateCurrentEngineText();
                saveSettings();
                document.getElementById('engineModal').style.display = 'none';
            });

            // 壁纸弹窗事件
            document.getElementById('wallpaperBtn').addEventListener('click', () => {
                document.getElementById('wallpaperModal').style.display = 'flex';
                showRefreshBtn(document.querySelector('input[name="wallpaperType"][value="network"]').checked);
            });
            document.getElementById('closeWallpaperModal').addEventListener('click', () => document.getElementById('wallpaperModal').style.display = 'none');
            document.getElementById('confirmWallpaper').addEventListener('click', () => {
                const selectedType = document.querySelector('input[name="wallpaperType"]:checked').value;
                if (selectedType === 'network') {
                    setRandomWallpaper();
                } else if (selectedType === 'none') {
                    setNoWallpaper();
                }
                document.getElementById('wallpaperModal').style.display = 'none';
            });

            // 壁纸刷新按钮
            document.getElementById('refreshWallpaperBtn').addEventListener('click', function(e) {
                e.stopPropagation();
                setRandomWallpaper(false);
            });

            // 本地壁纸选择
            document.querySelectorAll('input[name="wallpaperType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    showRefreshBtn(this.value === 'network');
                    if (this.value === 'local') {
                        document.getElementById('localWallpaper').click();
                    }
                });
            });

            // 本地壁纸文件上传
            document.getElementById('localWallpaper').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    localFileName = file.name;
                    fileToBase64(file, (base64) => {
                        if (base64) {
                            localFileBase64 = base64;
                            document.body.style.backgroundImage = `url(${localFileBase64})`;
                            document.body.style.backgroundColor = '';
                            wallpaperType = 'local';
                            document.getElementById('localFilename').textContent = localFileName;
                            document.querySelector('input[name="wallpaperType"][value="local"]').checked = true;
                            updateSelectedHighlight();
                            saveSettings();
                            adjustTextColorForBackground();
                        }
                    });
                }
            });

            // 主题颜色弹窗事件
            document.getElementById('themeBtn').addEventListener('click', () => {
                initColorOptions();
                document.getElementById('themeModal').style.display = 'flex';
            });
            document.getElementById('closeThemeModal').addEventListener('click', () => document.getElementById('themeModal').style.display = 'none');
            document.getElementById('confirmTheme').addEventListener('click', () => {
                applyTheme();
                document.getElementById('themeModal').style.display = 'none';
            });

            // 背景音乐弹窗事件
            document.getElementById('musicBtn').addEventListener('click', () => {
                document.getElementById('musicModal').style.display = 'flex';
                document.getElementById('volumeSlider').value = musicVolume;
            });
            document.getElementById('closeMusicModal').addEventListener('click', () => document.getElementById('musicModal').style.display = 'none');
            document.getElementById('confirmMusic').addEventListener('click', () => {
                const selectedType = document.querySelector('input[name="musicType"]:checked').value;
                musicType = selectedType;
                audioPlayer.pause();
                isMusicPlaying = false;

                if (musicType === 'none') {
                    localMusicBase64 = '';
                    localMusicFileName = '';
                    document.getElementById('localMusicName').textContent = '';
                    document.getElementById('musicControlBtn').style.display = 'none';
                } else if (musicType === 'default') {
                    audioPlayer.src = 'music.mp3';
                    document.getElementById('musicControlBtn').style.display = 'flex';
                    checkMusicModeAndShowPermissionModal();
                } else if (musicType === 'local' && localMusicBase64) {
                    audioPlayer.src = localMusicBase64;
                    document.getElementById('musicControlBtn').style.display = 'flex';
                    checkMusicModeAndShowPermissionModal();
                }
                saveSettings();
                updateMusicControlButton();
                document.getElementById('musicModal').style.display = 'none';
            });

            // 本地音乐选择
            document.querySelectorAll('input[name="musicType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.value === 'local') {
                        document.getElementById('localMusic').click();
                    }
                });
            });

            // 本地音乐文件上传
            document.getElementById('localMusic').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    localMusicFileName = file.name;
                    fileToBase64(file, (base64) => {
                        if (base64) {
                            localMusicBase64 = base64;
                            document.getElementById('localMusicName').textContent = localMusicFileName;
                            document.querySelector('input[name="musicType"][value="local"]').checked = true;
                            updateSelectedHighlight();
                            saveSettings();
                            audioPlayer.src = localMusicBase64;
                            document.getElementById('musicControlBtn').style.display = 'flex';
                        }
                    });
                }
            });

            // 音量调节
            document.getElementById('volumeSlider').addEventListener('input', function() {
                musicVolume = parseFloat(this.value);
                audioPlayer.volume = musicVolume;
                saveSettings();
            });

            // 音乐播放/暂停按钮点击事件
            document.getElementById('musicControlBtn').addEventListener('click', function() {
                isMusicPlaying ? pauseMusic() : playMusic();
            });

            // 音乐权限提示弹窗事件
            document.getElementById('musicPermissionConfirm').addEventListener('click', function() {
                playMusic();
                document.getElementById('musicPermissionModal').style.display = 'none';
            });
            document.getElementById('musicPermissionCancel').addEventListener('click', function() {
                document.getElementById('musicPermissionModal').style.display = 'none';
            });

            // 搜索按钮和回车事件
            document.getElementById('searchBtn').addEventListener('click', search);
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') search();
            });

            // 恢复默认设置弹窗事件 - 新增：清空历史记录
            document.getElementById('resetBtn').addEventListener('click', () => document.getElementById('resetModal').style.display = 'flex');
            document.getElementById('cancelReset').addEventListener('click', () => document.getElementById('resetModal').style.display = 'none');
            document.getElementById('confirmReset').addEventListener('click', () => {
                localStorage.removeItem('browserHomeSettings');
                localStorage.removeItem('searchHistory'); // 清空历史记录
                currentEngine = 'bing-cn';
                currentTheme = 'cherry-pink';
                currentThemeColor = '#FFF0F5';
                currentDarkColor = '#AA6666';
                wallpaperType = 'network';
                localFileName = '';
                localFileBase64 = '';
                musicType = 'none';
                localMusicFileName = '';
                localMusicBase64 = '';
                musicVolume = 0.5;
                searchHistory = []; // 清空内存中的历史记录
                audioPlayer.pause();
                isMusicPlaying = false;
                audioPlayer.src = 'music.mp3';
                isMenuOpen = false;

                document.querySelector('input[name="engine"][value="bing-cn"]').checked = true;
                document.querySelector('input[name="wallpaperType"][value="network"]').checked = true;
                document.querySelector('input[name="musicType"][value="none"]').checked = true;
                document.getElementById('localFilename').textContent = '';
                document.getElementById('localMusicName').textContent = '';
                document.getElementById('volumeSlider').value = 0.5;
                document.getElementById('searchInput').value = '';
                document.getElementById('searchIcon').textContent = 'search';

                document.getElementById('menuContent').classList.remove('show');
                document.getElementById('menuToggleText').textContent = '打开菜单';
                document.querySelector('#menuToggleBtn .material-icons').textContent = 'menu';

                initColorOptions();
                syncAllElementsTheme();
                updateCurrentEngineText();
                setRandomWallpaper();
                renderSearchHistory(); // 重新渲染空的历史记录
                document.getElementById('resetModal').style.display = 'none';
                alert('已成功恢复默认设置，搜索历史已清空！');
            });

            // 点击弹窗外部关闭弹窗
            window.addEventListener('click', function(e) {
                const modals = ['engineModal', 'wallpaperModal', 'themeModal', 'musicModal', 'resetModal', 'musicPermissionModal', 'historyModal']; // 新增：historyModal
                modals.forEach(modalId => {
                    const modal = document.getElementById(modalId);
                    if (e.target === modal) modal.style.display = 'none';
                });
            });

            // 单选框变化事件
            document.querySelectorAll('input[type="radio"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    updateSelectedHighlight();
                    if (this.name === 'themeColor') {
                        let tempDark = currentDarkColor;
                        for (const [name, [cls, code, darkCode]] of Object.entries(colorMap)) {
                            if (cls === this.value) {
                                tempDark = darkCode;
                                break;
                            }
                        }
                        document.querySelectorAll('.radio-option input[type="radio"]').forEach(r => {
                            r.style.border = `2px solid ${tempDark}`;
                            r.style.backgroundColor = r === this ? tempDark : 'transparent';
                        });
                    }
                });
            });
        }
    </script>
</body>
</html>
